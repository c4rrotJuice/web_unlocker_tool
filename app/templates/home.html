<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cite Unlocker Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="stylesheet" href="/static/css/navStyle.css">
</head>
<body class="has-navbar">

  <header class="navbar">
    <div class="navbar-container">
      <!-- Logo -->
      <div class="logo">
        <a href="/"><img src="/static/images/logo_transparent.png" alt="Logo"></a>
      </div>

      <!-- Menu -->
      <nav>
        <ul class="nav-links">
          <li><a href="/" class="active">Home</a></li>
          <li><a href="/dashboard" id="dashboardLink">Dashboard</a></li>
          <li><a href="/editor" id="editorLink">Editor</a></li>
          <li><a href="/static/pricing.html">Pricing</a></li>
          <li><a href="https://citeunlock.choneize.com/blog">Blog</a></li>
          <li><a href="https://citeunlock.choneize.com/terms">Terms & Policies</a></li>
          <li><a href="/auth" id="authButton">Sign in/Up</a></li>
        </ul>
      </nav>

      <!-- Button -->
      <div class="nav-btn">
        <a href="/" class="btn">Unlock a Page</a>
      </div>
    </div>
  </header>
  
<!--=======================================================-->
  
  <div class="container">
    <h1>Cite Unlocker Tool</h1>

    <form id="unblockForm">
      <input id="urlToFetch" type="text" name="url" placeholder="Enter URL" required>
      <label>
        <input type="checkbox" id="unlockMode" name="unlock" checked>
        Enable Unlock Mode
      </label>
      <button type="submit">View</button>
    </form>

    <div id="loader">Cleaning new click...</div>

    <h2 id="url_in_view">Viewing: {{ url }}</h2>
    <iframe id="iframe" src="/view?url={{ url }}"></iframe>
  </div>

  <!-- Footer -->
  <footer>
    <p>© 2025 Cite Unlocker Tool by Choneize</p>
  </footer>

  <!-- JS to handle iframe clicks and cleaning -->

<script>

const iframe = document.getElementById('iframe');
const loader = document.getElementById('loader');
const toast = window.webUnlockerUI?.createToastManager?.();
const unlockStatus = window.webUnlockerUI?.createUnlockStatusManager?.(toast);
async function buildAuthHeaders() {
  const token = await window.webUnlockerAuth?.getAccessToken?.();
  const headers = {
    'Content-Type': 'application/json',
  };
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }
  return headers;
}

// Load initial URL
async function loadInitialURL() {
  const urlParams = new URLSearchParams(window.location.search);
  const targetUrl = urlParams.get('url');
  const unlock = urlParams.get('unlock') === 'true';

  if (!targetUrl) return;

  loader.style.display = 'block';
  loader.innerText = 'Loading page...';
  unlockStatus?.setStage('UNLOCK_STARTED');
  unlockStatus?.setStage('FETCHING_CONTENT');

  try {
    const response = await fetch('/view', {
      method: 'POST',
      headers: await buildAuthHeaders(),
      body: JSON.stringify({ url: targetUrl, unlock: true })
    });

    if (!response.ok) {
      const payload = await response.json().catch(() => ({}));
      const mapped = window.webUnlockerUI?.mapApiError?.(payload) || { message: 'Unable to load page.' };
      throw new Error(mapped.message);
    }
    unlockStatus?.setStage('CLEANING_CONTENT');
    const html = await response.text();
    const blob = new Blob([html], { type: 'text/html' });
    iframe.src = URL.createObjectURL(blob);

    //Post original URL to iframe
    iframe.onload = () => {
      iframe.contentWindow.postMessage({ originalUrl: targetUrl }, '*');
    };

  } catch (error) {
    console.error('Error loading page:', error);
    loader.innerText = 'Error loading page.';
    unlockStatus?.fail(error.message || 'Error loading page.');
  } finally {
    loader.style.display = 'none';
    unlockStatus?.setStage('COMPLETE');
  }
}
window.onload = loadInitialURL;

// Dynamic navigation from inside iframe
window.addEventListener('message', async (event) => {
  const { newUrl } = event.data || {};
  if (!newUrl) return;

  loader.style.display = 'block';
  loader.innerText = 'Cleaning new click...';
  unlockStatus?.setStage('UNLOCK_STARTED');
  unlockStatus?.setStage('FETCHING_CONTENT');

  const urlInView = document.getElementById('url_in_view');
  if (urlInView) {
    urlInView.innerText = `Viewing: ${newUrl}`;
  }

  try {
    const response = await fetch('/fetch_and_clean_page', {
      method: 'POST',
      headers: await buildAuthHeaders(),
      body: JSON.stringify({ url: newUrl, unlock: true })
    });

    if (!response.ok) {
      const payload = await response.json().catch(() => ({}));
      const mapped = window.webUnlockerUI?.mapApiError?.(payload) || { message: 'Error loading content.' };
      throw new Error(mapped.message);
    }
    unlockStatus?.setStage('CLEANING_CONTENT');
    const data = await response.text();
    const blob = new Blob([data], { type: 'text/html' });
    const blobUrl = URL.createObjectURL(blob);
    iframe.src = blobUrl;

    //Post new URL to iframe
    iframe.onload = () => {
      iframe.contentWindow.postMessage({ originalUrl: newUrl }, '*');
    };

  } catch (error) {
    console.error('❌ Fetch error:', error);
    loader.innerText = 'Error loading content.';
    unlockStatus?.fail(error.message || 'Error loading content.');
  } finally {
    loader.style.display = 'none';
    unlockStatus?.setStage('COMPLETE');
  }
});

// Form submit to fetch new page
document.getElementById('unblockForm').addEventListener('submit', async (event) => {
  event.preventDefault();

  const urlToFetch = document.getElementById('urlToFetch').value;
  const unlockMode = document.getElementById('unlockMode').checked;
  if (!urlToFetch) return;

  loader.style.display = 'block';
  loader.innerText = 'Loading page...';
  unlockStatus?.setStage('UNLOCK_STARTED');
  unlockStatus?.setStage('FETCHING_CONTENT');

  const urlInView = document.getElementById('url_in_view');
  if (urlInView) {
    urlInView.innerText = `Viewing: ${urlToFetch}`;
  }

  const headers = await buildAuthHeaders();

  try {
    const response = await fetch('/view', {
      method: 'POST',
      headers: await buildAuthHeaders(),
      body: JSON.stringify({ url: urlToFetch, unlock: unlockMode })
    });

    if (!response.ok) {
      const payload = await response.json().catch(() => ({}));
      const mapped = window.webUnlockerUI?.mapApiError?.(payload) || { message: 'Unable to load page.' };
      throw new Error(mapped.message);
    }
    unlockStatus?.setStage('CLEANING_CONTENT');
    const html = await response.text();
    const blob = new Blob([html], { type: 'text/html' });

    iframe.src = URL.createObjectURL(blob);

    //Post the submitted URL to iframe
    iframe.onload = () => {
      iframe.contentWindow.postMessage({ originalUrl: urlToFetch }, '*');
    };

  } catch (error) {
    console.error('Error loading page:', error);
    loader.innerText = 'Error loading page.';
    unlockStatus?.fail(error.message || 'Error loading page.');
  } finally {
    loader.style.display = 'none';
    unlockStatus?.setStage('COMPLETE');
  }
});

//listen and capture the copycitation function from within the iframe
window.addEventListener('message', async (event) => {
  if (event.data?.type === 'copyCitation') {
    const citation = event.data.citation;

    try {
      const response = await fetch('/api/citations', {
        method: 'POST',
        headers: await buildAuthHeaders(),
        body: JSON.stringify(citation),
      });

      if (!response.ok) throw new Error('Citation save failed');
      console.log('✅ Citation saved');
    } catch (error) {
      console.error('❌ Failed to save citation:', error);
    }
  }
});

</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/static/js/ui_feedback.js"></script>
<script src="/static/js/auth.js"></script>
<script src="/static/js/nav.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/static/css/dashboard.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="stylesheet" href="/static/css/navStyle.css">
  <link rel="stylesheet" href="/static/css/theme.css">
  <title>Developer Metrics</title>
</head>
<body class="has-navbar">
  <header class="navbar">
    <div class="navbar-container">
      <div class="logo">
        <a href="/"><img src="/static/images/logo_transparent.png" alt="Logo" /></a>
      </div>
      <nav>
        <ul class="nav-links">
          <li><a href="/">Home</a></li>
          <li><a href="/dashboard">Dashboard</a></li>
          <li><a href="/editor">Editor</a></li>
          <li><a href="/dashboard/metrics" class="active">Metrics</a></li>
          <li><a href="/auth" id="authButton">Sign in/Up</a></li>
        </ul>
      </nav>
      <div class="nav-btn">
        <a href="/" class="btn">Unlock a Page</a>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="section">
      <h2>Developer Runtime Metrics</h2>
      <p id="metrics-summary">Loading metrics...</p>
      <pre id="metrics-output" style="white-space: pre-wrap; max-height: 65vh; overflow: auto; padding: 12px; background: #0b1220; color: #d1d5db; border-radius: 8px;"></pre>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/static/js/auth.js"></script>
  <script>
    async function loadDeveloperMetrics() {
      const token = await window.webUnlockerAuth?.getAccessToken?.();
      if (!token) {
        window.location.href = "/auth?next=/dashboard/metrics";
        return;
      }

      const meRes = await fetch('/api/me', {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (meRes.status === 401) {
        window.location.href = "/auth?next=/dashboard/metrics&reason=session";
        return;
      }

      if (!meRes.ok) {
        document.getElementById('metrics-summary').textContent = 'Failed to verify account. Please try again.';
        return;
      }

      const me = await meRes.json();
      if ((me.account_type || '').toLowerCase() !== 'dev') {
        window.location.href = '/dashboard';
        return;
      }

      const metricsRes = await fetch('/metrics', {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!metricsRes.ok) {
        document.getElementById('metrics-summary').textContent = 'Unable to load metrics.';
        return;
      }

      const body = await metricsRes.text();
      const lines = body.split('\n').filter(line => line && !line.startsWith('#'));
      document.getElementById('metrics-summary').textContent = `Loaded ${lines.length} runtime metric series.`;
      document.getElementById('metrics-output').textContent = body;
    }

    loadDeveloperMetrics().catch((err) => {
      console.error(err);
      document.getElementById('metrics-summary').textContent = 'Unexpected error while loading metrics.';
    });
  </script>
</body>
</html>
